I"Å<p>å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/loongembedded/article/details/54090873
åªæœ‰ä½¿ç”¨ç‰¹å®šç­¾åç­¾çš„apkæ‰å¯ä»¥å®‰è£…ï¼Œå…¶ä»–ä»»ä½•apkéƒ½ä¸èƒ½å®‰è£…</p>

<p>æœ€å¥½æ˜¯åº”ç”¨é¢„è£…ä¸€ä¸ªä½¿ç”¨å¯¹åº”ç­¾åçš„åº”ç”¨</p>

<p>éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æœ‰ä»¥ä¸‹å‡ ä¸ª
/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java</p>

<p>/frameworks/base/core/java/android/content/pmPackageManager.java</p>

<p>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallAppProgress.java</p>

<p>/packages/apps/PackageInstaller/res/values/string.xml</p>

<h2 id="1-packagemanagerservicejava">1 PackageManagerService.java</h2>
<p>/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java
æ·»åŠ getSignaturesByPackage()æ–¹æ³•</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="rouge-code"><pre>//add start
private Signature[] getSignaturesByPackage(){
Signature[] signatures = null;
//å·²ç­¾åçš„å·²å®‰è£…åº”ç”¨åŒ…åï¼Œä¸è¯¥åº”ç”¨ç­¾åä¸åŒçš„åº”ç”¨æ— æ³•å®‰è£…
String packageName = "com.xxxx.xxxxx";
PackageSetting ps = mSettings.mPackages.get(packageName);
if (ps != null) {
PackageParser.Package pkg = ps.pkg;
if (pkg == null) {
pkg = new PackageParser.Package(packageName);
pkg.applicationInfo.packageName = packageName;
pkg.applicationInfo.flags = ps.pkgFlags | ApplicationInfo.FLAG_IS_DATA_ONLY;
pkg.applicationInfo.publicSourceDir = ps.resourcePathString;
pkg.applicationInfo.sourceDir = ps.codePathString;
pkg.applicationInfo.dataDir = getDataPathForPackage(packageName, 0).getPath();
// pkg.applicationInfo.nativeLibraryDir = ps.nativeLibraryPathString;
}

PackageInfo packageInfo2 = generatePackageInfo(pkg, PackageManager.GET_SIGNATURES, UserHandle.getCallingUserId());

if(packageInfo2 != null){
signatures = packageInfo2.signatures;
}
}
mIsInstallApkFlag = false;
return signatures;
}
//add end
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åœ¨scanPackageLIæ–¹æ³•ä¸‹åŠ å…¥å¦‚ä¸‹ä»£ç </p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>private PackageParser.Package scanPackageLI(PackageParser.Package pkg, int parseFlags , int scanFlags, long currentTime, UserHandle user) throws PackageManagerException {
boolean success = false;
//add start  
//è·å¾—å®‰è£…çš„åº”ç”¨çš„ç­¾åä¿¡æ¯
Signature[] originalSignatures = getSignaturesByPackage();
if (originalSignatures != null) {
if (compareSignatures(originalSignatures, pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) {
int mLastScanError = PackageManager.INSTALL_FAILED_INVALID_SIGNATURES;
throw new PackageManagerException(mLastScanError,
"ç¦æ­¢å®‰è£…ï¼Œç­¾åä¸ç¬¦");
}
}
//add end
...
</pre></td></tr></tbody></table></code></pre></div></div>
<p>åŒæ—¶è¦importç¼ºå°‘çš„ç±»ã€‚</p>
<h2 id="2-packagemanagerjava">2 PackageManager.java</h2>
<p>/frameworks/base/core/java/android/content/pm/PackageManager.java
åŠ å…¥é”™è¯¯ä»£ç  INSTALL_FAILED_INVALID_SIGNATURES</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>/** 
* Installation return code: this is passed to the {@link IPackageInstallObserver} by 
* {@link #installPackage(android.net.Uri, IPackageInstallObserver, int)} if 
* the installed package hasn't the expected signature 
*  @hide 
*/
public static final int INSTALL_FAILED_INVALID_SIGNATURES = -26;
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="3-installappprogressjava">3 InstallAppProgress.java</h2>
<p>/packages/apps/PackageInstaller/src/com/android/packageinstaller/InstallAppProgress.java
åŠ å…¥é’ˆå¯¹æ·»åŠ çš„é”™è¯¯ä»£ç çš„å¤„ç†</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>private Handler mHandler = new Handler() {  
public void handleMessage(Message msg) {  
switch (msg.what) {  
...
//add start
} else if (msg.arg1 ==  PackageManager.INSTALL_FAILED_INVALID_SIGNATURES){
// Generic error handling for all other error codes.  
centerTextDrawable.setLevel(1);
centerExplanationLabel = getExplanationFromErrorCode(msg.arg1);
//centerTextLabel = R.string.install_failed_invalid_signature;  
centerTextLabel = R.string.install_failed_invalid_signature;
mLaunchButton.setVisibility(View.INVISIBLE);
//add end
}  else {
// Generic error handling for all other error codes.
centerTextDrawable.setLevel(1);
centerExplanationLabel = getExplanationFromErrorCode(msg.arg1);
centerTextLabel = R.string.install_failed;
mLaunchButton.setVisibility(View.INVISIBLE);
}
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="4-stringsxml">4 strings.xml</h2>
<p>/packages/apps/PackageInstaller/res/values/string.xml
æ·»åŠ é”™è¯¯ä¿¡æ¯install_failed_invalid_signature</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>&lt;string name="install_failed_invalid_signature"&gt;ç¦æ­¢å®‰è£…ï¼Œç­¾åä¸ç¬¦&lt;/string&gt;
</pre></td></tr></tbody></table></code></pre></div></div>

:ET